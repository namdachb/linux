# Network Interfaces
*Giao diện mạng là kênh kết nối giữa thiết bị và mạng. Về mặt vật lý, giao diện mạng có thể tiến hành thông qua giao diện mạng (**NIC**) hoặc có thể được triển khai trừu tượng dưới dạng phần mềm. Bạn có thể có nhiều giao diện mạng hoạt động cùng một lúc. Các giao diện cụ thể có thể được đưa lên (kích hoạt) hoặc đưa xuống (khử kích hoạt) bất cứ lúc nào. Một danh sách các giao diện mạng hiện hoạt động được báo cáo bởi `ifconfig` tiện ích. Các tập tin cấu hình mạng là rất cần thiết để đảm bảo các giao diện hoạt động chính xác*

*Đối với cấu hình họ **Desbian**, tệp cấu hình mạng cơ bản là `/etc/network/interfaces`. Đối với cấu hình hệ thống gia đình **RedHat**, thông tin định tuyến và máy chủ được chứa trong `/etc/sysconfig/network`. Kịch bản cấu hình giao diện mạng cho `eth0` giao diện được đặt tại `/etc/sysconfig/network-scripts/ifcfg-eth0`. Đối với cấu hình hệ thống cho **SUSE**, tập lệnh định tuyến và thông tin máy chủ và giao diện mạng được chứa trong `/etc/sysconfig/network` thư mục*
## Các file cấu hình Network
1. `/etc/hosts`
 * Dùng để phân giải những hostnam không thể phân giải được
 * Có thể dùng thay DNS trong hệ thống mạng LAN
    * `127.0.0.1` <=> `localhost.localdomain`
    * `: :1` <=> `localhost.localdomain`
```
[root@localhost ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
```
2. `/etc/resolv.conf`
 * Dùng để cấu hình DNS
```
[root@localhost ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search localdomain
nameserver 192.168.213.2
```

3. `/etc/sysconfig/network-scripts/ifcfg-[tên_card_mạng]`
 * Chứa thông tin cấu hình của từng card mạng
     * `ens33` : ethernet (có sẵn)
     * `sl*` : serial line IP
     * `wl*` : wlan (wifi)
     * `ww*` : wwan (wireless WAN -3G/4G)
     * `virbr0` : bridge (có sẵn)
     * `lo*` : loopback (có sẵn)
```
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens33
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens33
UUID=f5d23247-ecf1-4d4c-ae72-f7211e66e306
DEVICE=ens33
ONBOOT=yes
```
## Các lệnh Network cơ bản
1. Xem địa chỉ IP
```
# ifconfig     (Ethernet + Loopback)
# iwconfig     (Wifi)
# ifconfig -a  (đầy đủ thông tin)
# ip a s       (đầy đủ thông tin)
```

```
[root@localhost ~]# ifconfig
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.213.150  netmask 255.255.255.0  broadcast 192.168.213.255
        inet6 fe80::b81b:2fda:5fbf:843f  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:4c:36:8c  txqueuelen 1000  (Ethernet)
        RX packets 1199  bytes 104896 (102.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 832  bytes 88060 (85.9 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0


```
2. Tắt / Bật card mạng
```
# ifup [tên_card_mạng]   : bật card mạng
# ifdown [tên_card_mạng] : tắt card mạngx
```
3. Khởi động lại `network.service`
```
    # service network restart
<=> # /etc/init.d/network restart
<=> # systemctl restart network.service
```
4. Xem thông tin gateway
```
# route
# ip route
```

```
[root@localhost ~]# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    100    0        0 ens33
192.168.213.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
[root@localhost ~]# ip route
default via 192.168.213.2 dev ens33 proto dhcp metric 100
192.168.213.0/24 dev ens33 proto kernel scope link src 192.168.213.150 metric 100

```
5. Cấu hình IP
*Cấu hình bằng lệnh (tạm thời)*
 `$ ifconfig [tên_card_mạng] [IP] netmask [subnet_mask] ip`

> ***Chú ý*** : IP sẽ mất mỗi khi tắt mở card mạng hay restart `network.service`. Đây còn gọi là cách đặt IP tạm thời, thường dùng để test.

*Cấu hình bằng file*
 * Thay đổi nội dung trong file cấu hình của card mạng:
 `# vi /etc/sysconfig/network-scripts/ifcfg-[tên_card_mạng]`
```
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens33
UUID=f5d23247-ecf1-4d4c-ae72-f7211e66e306
DEVICE=ens33
ONBOOT=yes

```
 * Ý nghĩa các thông số trong file :
  * `DEVICE` : tên của card mạng
  * `ONBOOT` :
     * `yes` : khởi động khi restart `network.service`
     * `no` : không khởi động khi restart `network.service`
  * `BOOTPROTO` :
     * `static` : dùng IP tĩnh
     * `dhcp` : nhận IP từ DHCP Server
  * `IPADDR` : địa chỉ IP của card mạng (khi cấu hình IP tĩnh)
  * `NETMASK` : địa chỉ subnetmask (khi cấu hình IP tĩnh )
  * `GATEWAY` : đĩa chỉ gateway (khi cấu hình IP tĩnh)
  * `DNS[1|2]` : địa chỉ DNS Server (khi cấu hình IP tĩnh)
  * `USERCTL` : 
     * `yes` : cho phép user thường cấu hình sửa đổi
     * `no` : không cho phép user thường cấu hình sửa đổi
 * VD : thiết bị IP tĩnh cho Server với IP `192.168.17.11/24`, gateway `192.168.17.1`, DNS là `8.8.8.8`, `8.8.4.4`
```
DEVICE=ens37
ONBOOT=yes
BOOTPROTO=static
IPADDR=192.168.17.11
NETMASK=255.255.255.0
GATEWAY=192.168.17.1
DNS1=8.8.8.8
DNS2=8.8.4.4
USERCTL=no
```

 *VD : thiết lập IP động
```
DEVICE=ens33
ONBOOT=yes
BOOTPROTO=dhcp
USERCTL=no
```
6. Cấu hình bằng `nmcli`
 * Đây là công cụ giúp điều khiển trình quản lý mạng trong Linux bằng dòng lệnh
 * Xem các trạng thái kết nối cơ bản: 
   
   `# nmcli [optins] [command] [arguments]`
   * Options :
     * `-a` : hiển thị đầy đủ thông tin về phần cứng card gồm MAC, MTU, IP ,..
   * Commands + Arguments :
     * `general` :
       * `status`
       * `hostname` : hiển thị hostnam
     * `network` :
       * `on` : enable card mạng
       * `off` : disable card mạng
       * `connectivity` : xem trạng thái kết nối :
         * full : đã kết nối mạng và được truy cập internet
         * limited : đã kết nối mạng nhưng không được phép truy cập internet
         * none : chưa được kết nối mạng
     * `radio` :
        * `all` : hiển thị trạng thái tất cả các kết nối không dây
        * `on` : enable card wifi
     * `monitor` : quản lý status mạng theo runtime
     * `connection` (`con`):
        * `show --active` : hiển thị các kết nối đang active
     * `device (dev)` : 
        * `status`: hiển thị trạng thái các interface
        * `show if_name` : hiển thị thông tin chi tiết của interface
        * `wifi list` : liệt kê các sóng wifi bắt được
          * `--auto`
          * `--rescan`
        * `wifi connect` : kết nối tới mạng wifi đã biết
          * `SSID password "password"`

## Lệnh `ip`:
### Lệnh trả lại thông tin trên từng thiết bị Ethernet được kết nối.
`# ip addr show`
```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.213.150/24 brd 192.168.213.255 scope global noprefixroute dynamic ens33
       valid_lft 1208sec preferred_lft 1208sec
    inet6 fe80::b81b:2fda:5fbf:843f/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
*Để xem thông tin về `ens33`:*
```
[root@localhost ~]# ip addr show ens33
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.213.150/24 brd 192.168.213.255 scope global noprefixroute dynamic ens33
       valid_lft 1081sec preferred_lft 1081sec
    inet6 fe80::b81b:2fda:5fbf:843f/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
### Hiển thị bảng định tuyến
`ip route show`
```
[root@localhost ~]# ip route show
default via 192.168.213.2 dev ens33 proto dhcp metric 100
192.168.213.0/24 dev ens33 proto kernel scope link src 192.168.213.150 metric 100
```
### Gán IP cho một giao diện mạng:
`# ip addr add  192.168.213.151 dev ens33`
```
[root@localhost ~]# ip addr show dev ens33
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.213.150/24 brd 192.168.213.255 scope global noprefixroute dynamic ens33
       valid_lft 1495sec preferred_lft 1495sec
    inet 192.168.213.151/32 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::b81b:2fda:5fbf:843f/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
### Gán nhiều IP cho một giao diện mạng:
*Để gán nhiều IP cho giao diện mạng ta làm tương tự như trên*
### Gỡ bỏ IP từ giao diện mạng
`# ip addr del 192.168.213.152/32 dev ens33`
```
[root@localhost ~]# ip addr del 192.168.213.151/32 dev ens33
[root@localhost ~]# ip addr show dev ens33
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.213.150/24 brd 192.168.213.255 scope global noprefixroute dynamic ens33
       valid_lft 1362sec preferred_lft 1362sec
    inet6 fe80::b81b:2fda:5fbf:843f/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
### Hiển thị thông tin về một giao diện mạng
```
[root@localhost ~]# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
```
### Thay đổi trạng thái giao diện mạng (up/down)
`ip link set dev {DEVICE} {up|down}`
### Hiển thị bảng định tuyến
`ip route`
```
[root@localhost ~]# ip route
default via 192.168.213.2 dev ens33 proto dhcp metric 100
192.168.213.0/24 dev ens33 proto kernel scope link src 192.168.213.150 metric 100
```
### Thêm một định tuyến mới
`# ip route add 192.168.213.0/24 via 192.168.213.1`
### Xóa một định tuyến
`ip route del defaulf`

*Hoặc chỉ định tuyến cần xóa*

`ip route del <dia_chi_ip> via <gateway>`

## Lệnh Route
*Hiện tại bộ công cụ `iproute2` đã được thay thế mặc định cho bộ công cụ `net-tools` ở các bản phân phối linux mới như RHEL7, CentOS ..vv , dẫn tới bạn sẽ gặp lỗi `-bash: ifconfig: command not found` trên centos 7. Cài đặt `net-tools` trên centos 7 :*

`yum install net-tools`

*Lệnh `route` được sử dụng để xem hoặc thay đổi bảng định tuyến IP. Bạn có thể muốn thay đổi bảng định tuyến IP để thêm, xóa hoặc sửa đổi các tuyến tĩnh thành các máy chủ hoặc mạng cụ thể*

### Hiển thị bảng định tuyến
`# route -n`
```
[root@localhost ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.213.2   0.0.0.0         UG    100    0        0 ens33
192.168.213.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
```
### Thêm một định tuyến
`# route add -net 192.168.1.0 netmask 255.255.255.0 dev ens33`
```
[root@localhost ~]# route add -net 192.168.1.0 netmask 255.255.255.0 dev ens33
[root@localhost ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.213.2   0.0.0.0         UG    100    0        0 ens33
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 ens33
192.168.213.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
```

### Xóa một định tuyến
`# route del -net 192.168.1.0 netmask 255.255.255.0 dev ens33`
```
[root@localhost ~]# route del -net 192.168.1.0 netmask 255.255.255.0 dev ens33
[root@localhost ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.213.2   0.0.0.0         UG    100    0        0 ens33
192.168.213.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
```

### Cách thay đổi card mạng về dạng `eth*`
*Kiểm tra tên Network interface hiện tại*

`ip a`
```
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group                                                                                                    default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.213.150/24 brd 192.168.213.255 scope global noprefixroute dynamic en                                                                                                   s33
       valid_lft 1250sec preferred_lft 1250sec
    inet6 fe80::6eb4:dc2c:d90:bca3/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
*Ta thấy tên hiện tại của Network interface là `ens33`. Chúng ta sẽ đưa tên Network interface về dạng `eth0, eth1, ...`*
### 1. Chỉnh sửa tham số Kernel boot
Chỉnh sửa file `/etc/default/grub`
Tìm đến dòng `GRub_CMDLINE_LINUX` và thêm đoạn sau `net.ifnames=0 biosdevname=0`. Ta sẽ được dòng sau:

```
GRUB_CMDLINE_LINUX="crashkernel=auto net.ifnames=0 biosdevname=0 rhgb quiet"
```
Sinh lại tệp GRUB và ghi đè lên tệp hiện có

`grub2-mkconfig -o /boot/grub2/grub.cfg`

### 2. Chỉnh sửa file cấu hình mạng
Chỉnh sửa file cấu hình mạng ban đầu là `ens33`. Tại mục `NAME` và `DEVICE`, ta đổi từ `ens33` thành `eth0`
```
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=eth0
UUID=f5d23247-ecf1-4d4c-ae72-f7211e66e306
DEVICE=eth0
ONBOOT=yes
```

Sửa tên file cấu hình mạng: `ifcfg-ens33` thành `ifcfg-eth0`
```
[root@localhost network-scripts]# mv /etc/sysconfig/network-scripts/ifcfg-ens33 /etc/sysconfig/network-scripts/ifcfg-eth0
```
### 3. Disable NetworkManager
Đảm bảo rằng NetworkManager không hoàn nguyên các thay đổi khi khởi động lại máy hay khởi động lại mạng

`systemctl disable NetworkManager`

### 4. Reboot máy và kiểm tra lại
Reboot máy để những thay đổi được thực hiện
`reboot`

Kiểm tra lại tên thiết bị 

`ip a`
```
[root@localhost ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:4c:36:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.213.150/24 brd 192.168.213.255 scope global noprefixroute dynamic eth0
       valid_lft 1499sec preferred_lft 1499sec
    inet6 fe80::bfbb:895e:8cbb:7ab9/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
Kiểm tra kết nối Internet

`ping 8.8.8.8`
```
[root@localhost ~]# ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=128 time=73.1 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=128 time=58.4 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=128 time=69.2 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=128 time=57.4 ms
```
